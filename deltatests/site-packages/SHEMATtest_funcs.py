"""
Utility functions for SHEMATtest
"""
import os

try:
    from pskf.tools.run import runmodule as rm
except ImportError:
    raise ImportError(
        'No module named pskf.tools.run.runmodule. \n\n' + 'Solution: ' +
        'Download pyshemkf from https://github.com/jjokella/pyshemkf and add' +
        ' the path /path-to-pyshemkf/pyshemkf/site-packages to the' +
        ' PYTHONPATH.')


def compilequick(
        deltatests_dir,
        make_dir,
        shem_type,
        shem_type_name,
        compiler,
        compiler_name,
        props,
        flags,
        module_load,
        git_branch,
):
    """
    Invoking the compilation via the script compilequick.sh
    """

    # Generate executable compilequick_run.sh by inserting specifications
    compilation_script = (deltatests_dir + '/' + 'compilequick.sh'
                          if not git_branch == 'cmake' else
                          deltatests_dir + '/' + 'compilequick_cmake.sh')
    f = open(compilation_script, 'r')
    fcontent = f.read()
    f.close()

    fcontentwrite = fcontent.format(
        deltatests_dir_in=deltatests_dir,
        make_dir_in=make_dir,
        shem_type_in=shem_type,
        shem_type_name_in=shem_type_name,
        compiler_in=compiler,
        compiler_name_in=compiler_name,
        props_in=props,
        flags_in=flags,
        module0=module_load[0],
        module1=module_load[1],
        module2=module_load[2],
        module3=module_load[3],
        module4=module_load[4],
        git_branch_in=git_branch,
        HOME='{HOME}',
        make_dir='{make_dir}',
        compiler_name='{compiler_name}',
        props='{props}',
        git_branch='{git_branch}',
        shem_type='{shem_type}',
        compiler='{compiler}',
        flags='{flags}',
        shem_type_name='{shem_type_name}',
        new_exe_suffix='{new_exe_suffix}',
        deltatests_dir='{deltatests_dir}',
    )

    fnew = open(deltatests_dir + '/' + 'compilequick_run.sh', 'w')
    fnew.write(fcontentwrite)
    fnew.close()

    # Change file permission
    os.chmod(deltatests_dir + '/' + 'compilequick_run.sh', 0770)

    # Run compilequick_run.sh
    comp_out_file = open(deltatests_dir + '/' + 'compilequick.out', 'w')
    rm.run_script(
        deltatests_dir,
        './' + 'compilequick_run.sh',
        outfile=comp_out_file,
        wait=True,
        errout=True)
    comp_out_file.close()
